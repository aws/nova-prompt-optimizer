# Nova Prompt Optimizer - Comprehensive Codebase Analysis

*Generated by Claude on August 3, 2025*

## Executive Summary

The Nova Prompt Optimizer is a sophisticated Python SDK designed to optimize prompts for Amazon's Nova models using AWS Bedrock. The project combines a modular adapter-based architecture with advanced optimization algorithms, complemented by a comprehensive web interface for non-technical users.

## Project Architecture Overview

### Core Philosophy
The project follows a **modular adapter pattern** where each component of the prompt optimization pipeline is abstracted into specialized adapters:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Prompt Adapter │    │ Dataset Adapter │    │ Metric Adapter  │
│                 │    │                 │    │                 │
│ - Text loading  │    │ - JSON/CSV      │    │ - Custom eval   │
│ - Variable mgmt │    │ - Train/test    │    │ - Batch scoring │
│ - Templating    │    │ - Stratification│    │ - Aggregation   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Inference       │
                    │ Adapter         │
                    │                 │
                    │ - AWS Bedrock   │
                    │ - Rate limiting │
                    │ - Nova models   │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Optimization    │
                    │ Adapter         │
                    │                 │
                    │ - NovaPromptOpt │
                    │ - MIPROv2       │
                    │ - Meta Prompting│
                    └─────────────────┘
```

## Directory Structure Analysis

### Root Level Organization
```
nova-prompt-optimizer/
├── src/amzn_nova_prompt_optimizer/     # Core SDK package
├── ui/                                 # Web interface (full-stack)
├── samples/                           # Example implementations
├── docs/                             # SDK documentation
├── tests/                            # Comprehensive test suite
├── .kiro/                           # Project design & tasks
├── deploy.sh                        # Automated deployment
└── README.md                        # Main documentation
```

### Core SDK Structure (`src/amzn_nova_prompt_optimizer/`)
```
core/
├── input_adapters/
│   ├── prompt_adapter.py           # TextPromptAdapter - prompt loading/templating
│   ├── dataset_adapter.py          # JSON/CSV dataset handling with stratification
│   └── metric_adapter.py           # Custom evaluation metrics framework
├── inference/
│   ├── adapter.py                  # BedrockInferenceAdapter with rate limiting
│   ├── bedrock_converse.py         # AWS Bedrock integration
│   └── inference_constants.py     # Model configuration constants
├── optimizers/
│   ├── adapter.py                  # Base optimizer interface
│   ├── nova_prompt_optimizer/      # Combined meta-prompting + MIPROv2
│   ├── nova_meta_prompter/         # Nova-specific meta prompting
│   └── miprov2/                    # MIPROv2 implementation with custom adapters
└── evaluation/
    └── __init__.py                 # Evaluation framework with scoring
```

### Web Interface Structure (`ui/`)
```
ui/
├── frontend/                       # React + TypeScript + Vite
│   ├── src/
│   │   ├── components/            # Reusable UI components
│   │   ├── pages/                 # Route-based page components
│   │   ├── services/              # API integration layer
│   │   ├── hooks/                 # Custom React hooks
│   │   ├── types/                 # TypeScript type definitions
│   │   └── store/                 # State management
│   ├── public/                    # Static assets
│   └── dist/                      # Built frontend assets
├── backend/                       # FastAPI + SQLAlchemy + Alembic
│   ├── app/
│   │   ├── routers/              # API route handlers
│   │   ├── models/               # Database models
│   │   ├── services/             # Business logic layer
│   │   ├── core/                 # Configuration and utilities
│   │   ├── adapters/             # SDK integration adapters
│   │   └── db/                   # Database configuration
│   ├── migrations/               # Alembic database migrations
│   ├── tests/                    # Backend test suite
│   └── uploads/                  # File upload storage
├── scripts/                      # Deployment and utility scripts
├── monitoring/                   # Prometheus + Grafana configuration
└── docs/                        # Web interface documentation
```

## Key Components Deep Dive

### 1. Adapter Pattern Implementation

**Prompt Adapter (`prompt_adapter.py`)**
- **Purpose**: Standardizes prompt loading from various sources
- **Key Features**:
  - Variable extraction and validation
  - Jinja2 templating support
  - System/user prompt separation
  - JSON serialization for pipeline compatibility
- **Implementation**: `TextPromptAdapter` with file/content loading

**Dataset Adapter (`dataset_adapter.py`)**
- **Purpose**: Unified dataset handling with ML-ready features
- **Key Features**:
  - JSON/CSV format support
  - Automatic train/test splitting
  - Stratified sampling for balanced datasets
  - Column mapping and validation
- **Implementation**: `JSONDatasetAdapter`, `CSVDatasetAdapter`

**Metric Adapter (`metric_adapter.py`)**
- **Purpose**: Custom evaluation metric framework
- **Key Features**:
  - Single-row and batch evaluation
  - Numerical scoring (0-1 range for optimizers)
  - Extensible base class for custom metrics
- **Implementation**: Abstract base class with `apply()` and `batch_apply()` methods

**Inference Adapter (`adapter.py`)**
- **Purpose**: AWS Bedrock integration with safety features
- **Key Features**:
  - Rate limiting (configurable TPS)
  - Nova model support
  - Converse API integration
  - Error handling and retry logic
- **Implementation**: `BedrockInferenceAdapter` with boto3

### 2. Optimization Algorithms

**NovaPromptOptimizer** (Primary Algorithm)
- **Architecture**: Two-stage optimization
  1. **Meta Prompting**: Nova-specific prompt analysis and structuring
  2. **MIPROv2**: Advanced few-shot optimization with candidate generation
- **Features**:
  - Mode-based model selection (lite/pro/premier/micro)
  - Custom parameter support
  - JSON fallback handling
  - Structured output parsing

**MIPROv2 Implementation**
- **Purpose**: Advanced prompt optimization with few-shot learning
- **Features**:
  - Candidate generation and evaluation
  - Bootstrap demonstration selection
  - Multi-trial optimization
  - Custom LM adapters for Nova models

**Nova Meta Prompter**
- **Purpose**: Nova-specific prompt engineering guidance
- **Features**:
  - System instruction identification
  - User template optimization
  - Nova prompting best practices integration

### 3. Web Interface Architecture

**Frontend (React + TypeScript)**
- **Framework**: Vite + React 18 + TypeScript
- **UI Library**: Radix UI + Tailwind CSS + shadcn/ui
- **Key Features**:
  - Dataset management with drag-drop upload
  - Visual prompt editor with variable detection
  - Real-time optimization monitoring
  - Results visualization and comparison
  - Custom metrics code editor
  - Human annotation workflows

**Backend (FastAPI + SQLAlchemy)**
- **Framework**: FastAPI with async support
- **Database**: SQLite (development) / PostgreSQL (production)
- **Key Features**:
  - RESTful API with OpenAPI documentation
  - WebSocket support for real-time updates
  - File upload handling
  - SDK integration layer
  - Background task processing
  - Database migrations with Alembic

**Deployment Architecture**
- **Containerization**: Docker + Docker Compose
- **Services**: Frontend (Nginx), Backend (Uvicorn), Database, Redis
- **Monitoring**: Prometheus + Grafana (optional)
- **Development**: Hot reload, automated testing, CI/CD

## Technology Stack Analysis

### Core Dependencies
```python
# ML/AI Framework
dspy                    # MIPROv2 optimization algorithms
boto3                   # AWS SDK for Bedrock integration
jinja2                  # Template engine for prompt formatting

# Data Processing
numpy                   # Numerical operations
pandas                  # Data manipulation (implied from CSV support)

# Utilities
urllib3                 # HTTP client
virtualenv              # Environment isolation
```

### Web Interface Dependencies
```typescript
// Frontend
react                   # UI framework
typescript              # Type safety
vite                    # Build tool and dev server
tailwindcss            # Utility-first CSS
@radix-ui/*            # Accessible UI primitives
lucide-react           # Icon library
react-hook-form        # Form handling
zod                    # Schema validation
```

```python
# Backend
fastapi                # Modern Python web framework
sqlalchemy             # ORM and database toolkit
alembic                # Database migration tool
uvicorn                # ASGI server
pydantic               # Data validation
```

## Development Workflow & Patterns

### Code Organization Principles
1. **Separation of Concerns**: Each adapter handles one aspect of the pipeline
2. **Abstract Base Classes**: Consistent interfaces across implementations
3. **Dependency Injection**: Components accept other adapters as dependencies
4. **Method Chaining**: Fluent interfaces for adapter operations
5. **Type Safety**: Comprehensive type hints throughout

### Testing Strategy
```
tests/
├── core/
│   ├── input_adapters/        # Unit tests for each adapter
│   ├── inference/             # AWS integration tests (mocked)
│   ├── optimizers/            # Optimization algorithm tests
│   └── evaluation/            # Evaluation framework tests
└── util/                      # Utility function tests
```

### Import Patterns
- Absolute imports from package root
- Specific class/function imports over module imports
- Grouped imports: standard library → third-party → local modules

## Deployment & Infrastructure

### Automated Deployment (`deploy.sh`)
- **System Support**: Linux, macOS, Windows (WSL)
- **Features**:
  - Dependency installation (Docker, Python, Node.js)
  - Environment configuration with secure password generation
  - Health checks and verification
  - Backup and rollback capabilities
  - Multiple deployment modes (SDK-only, web-only, full)

### Environment Configuration
- **Development**: Simple setup with minimal configuration
- **Production**: Comprehensive security, monitoring, and scaling
- **Required Variables**: AWS credentials, database passwords, secret keys
- **Optional Features**: Monitoring stack, custom domains, SSL

### Container Architecture
```yaml
services:
  frontend:     # Nginx serving React build
  backend:      # FastAPI application
  db:          # PostgreSQL database
  redis:       # Caching and session storage
  prometheus:  # Metrics collection (optional)
  grafana:     # Monitoring dashboard (optional)
```

## Integration Points

### AWS Bedrock Integration
- **Authentication**: IAM roles or access keys
- **Models Supported**: All Nova model variants (lite, pro, premier, micro)
- **Rate Limiting**: Configurable TPS to prevent throttling
- **Error Handling**: Retry logic and graceful degradation

### SDK-Web Interface Integration
- **Adapter Layer**: Backend adapters translate web requests to SDK calls
- **File Management**: Upload handling for datasets and prompts
- **Real-time Updates**: WebSocket integration for optimization progress
- **Result Storage**: Database persistence of optimization results

## Sample Implementation Analysis

### Facility Support Analyzer
Located in `samples/facility-support-analyzer/`, this provides:
- **Use Case**: Email classification (category, urgency, sentiment)
- **Implementations**: 
  - User prompt only optimization
  - System + user prompt optimization
- **Data Format**: CSV/JSONL with input/output columns
- **Notebooks**: Jupyter notebooks demonstrating complete workflows

## Security & Best Practices

### Security Measures
- **AWS Credentials**: Environment variable configuration
- **Rate Limiting**: Prevents API abuse
- **Input Validation**: Comprehensive data validation
- **File Upload Security**: Type checking and size limits
- **Database Security**: Parameterized queries, migration management

### Development Best Practices
- **Type Safety**: Full type annotation with `py.typed` marker
- **Error Handling**: Comprehensive exception handling
- **Logging**: Structured logging throughout the application
- **Testing**: Unit tests with mocking for external dependencies
- **Documentation**: Comprehensive README and inline documentation

## Current Status & Roadmap

### Preview Status
- **Current State**: Public preview with active development
- **Stability**: Core functionality stable, API may evolve
- **Feedback**: Actively seeking user feedback and contributions

### Known Limitations
- **Model Support**: Currently Nova-specific (extensible architecture)
- **Dataset Size**: Memory-based processing (suitable for typical prompt optimization datasets)
- **Deployment**: Primarily designed for single-node deployment

## Conclusion

The Nova Prompt Optimizer represents a well-architected, production-ready solution for prompt optimization. Its modular design enables easy extension and customization, while the comprehensive web interface makes it accessible to non-technical users. The combination of advanced optimization algorithms (MIPROv2 + Meta Prompting) with practical deployment tools creates a complete ecosystem for prompt engineering workflows.

The codebase demonstrates strong software engineering practices with clear separation of concerns, comprehensive testing, and thoughtful user experience design. The automated deployment system and extensive documentation lower the barrier to adoption, while the extensible architecture supports future enhancements and integrations.
